{{!
    This file is part of Moodle - https://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template tool_speedtest/index

    Show a speed test

    Example context (json):
    {
    }
}}

<script src="speedtest.js"></script>
<script>
var s = new Speedtest();

function renderNumber(number) {
    if (isNaN(number)) {
        return number;
    }
    var flt = parseFloat(number);
    if (flt < 10) {
        return flt.toFixed(1);
    }
    if (flt >= 10) {
        return flt.toFixed(0);
    }
    return number;
}

s.onupdate = function(data){
    if (data.testState == 5) {
        // Speedtest is aborted, leave info intact.
        return;
    }
    I( "network").textContent = data.clientIp;
    I(  "dlText").textContent = (data.testState == 1 && data.dlStatus == 0) ? "..." : renderNumber(data.dlStatus);
    I(  "ulText").textContent = (data.testState == 3 && data.ulStatus == 0) ? "..." : renderNumber(data.ulStatus);
    I("pingText").textContent = renderNumber(data.pingStatus);
    I( "jitText").textContent = renderNumber(data.jitterStatus);
}

s.onend = function(aborted) {
    var button = I("startStopBtn");
    if (aborted) {
        button.className = "btn btn-primary";
    } else {
        button.className = "btn btn-success";
    }
    button.innerHTML = button.dataset.start;
}

function startStop(){ // Start/stop button pressed.
    if (s.getState() == 3) {
        // Speedtest is running, abort.
        s.abort();
    } else {
        // Test is not running, begin.
        s.start();
        var button = I("startStopBtn");
        button.className = "btn btn-primary btn-warning";
        button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ' + button.dataset.abort;
    }
}

function I(id) {
    return document.getElementById(id);
}
</script>
<div id="test">
    <div>
        <button id="startStopBtn" class="btn btn-primary" onclick="startStop()"
 data-start="{{#str}} testrerun, tool_speedtest {{/str}}"
 data-abort="{{#str}} testabort, tool_speedtest {{/str}}"
    >{{#str}} teststart, tool_speedtest {{/str}}</button>
    </div>
    <div class="testGroup">
        <div class="testArea">
            <div class="testName">{{#str}} download, tool_speedtest {{/str}}</div>
            <div id="dlText" class="meterText"></div>
            <div class="unit">Mbps</div>
        </div>
        <div class="testArea">
            <div class="testName">{{#str}} upload, tool_speedtest {{/str}}</div>
            <div id="ulText" class="meterText"></div>
            <div class="unit">Mbps</div>
        </div>
    </div>
    <div class="testGroup">
        <div class="testArea">
            <div class="testName">{{#str}} ping, tool_speedtest {{/str}}</div>
            <div id="pingText" class="meterText"></div>
            <div class="unit">ms</div>
        </div>
        <div class="testArea">
            <div class="testName">{{#str}} jitter, tool_speedtest {{/str}}</div>
            <div id="jitText" class="meterText"></div>
            <div class="unit">ms</div>
        </div>
    </div>
    <div>
        {{#str}} ipaddress, tool_speedtest {{/str}}:
        <span id="ip">{{{iplookup}}}</span>
    </div>
    <div>
        {{#str}} location, tool_speedtest {{/str}}:
        <span id="location">{{location}}</span>
    </div>
    <div>
        {{#str}} network, tool_speedtest {{/str}}:
        <span id="network">-</span>
    </div>
</div>
